(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{343:function(n,e,t){var content=t(474);"string"==typeof content&&(content=[[n.i,content,""]]),content.locals&&(n.exports=content.locals);(0,t(40).default)("31ebe3ef",content,!0,{sourceMap:!1})},344:function(n,e,t){var content=t(476);"string"==typeof content&&(content=[[n.i,content,""]]),content.locals&&(n.exports=content.locals);(0,t(40).default)("2932acaf",content,!0,{sourceMap:!1})},473:function(n,e,t){"use strict";var o=t(343);t.n(o).a},474:function(n,e,t){(n.exports=t(39)(!1)).push([n.i,"@media screen and (orientation:portrait){.black-head{height:20vh}.title{line-height:12vh}}@media screen and (orientation:landscape){.black-head{height:30vh}.title{line-height:19vh}}.black-head{width:100vw;background:linear-gradient(90deg,#7e0f4b,#1a5865);margin:0;color:snow}.title{text-align:center;font-family:Bungee Inline;font-weight:400;margin-top:0;color:#fff}.title span{margin-right:-.5vw;-webkit-animation:bakemono 10s ease-in-out infinite;animation:bakemono 10s ease-in-out infinite}@-webkit-keyframes bakemono{0%{font-family:Bungee Inline}to{font-family:Bungee Shade}}@keyframes bakemono{0%{font-family:Bungee Inline}to{font-family:Bungee Shade}}.title span:first-of-type{-webkit-animation-delay:0s;animation-delay:0s}.title span:nth-of-type(2){-webkit-animation-delay:.1s;animation-delay:.1s}.title span:nth-of-type(3){-webkit-animation-delay:.25s;animation-delay:.25s}.title span:nth-of-type(4){-webkit-animation-delay:.45s;animation-delay:.45s}.title span:nth-of-type(5){-webkit-animation-delay:.7s;animation-delay:.7s}.title span:nth-of-type(6){-webkit-animation-delay:1s;animation-delay:1s}.title span:nth-of-type(7){-webkit-animation-delay:1.35s;animation-delay:1.35s}.title span:nth-of-type(8){-webkit-animation-delay:1.75s;animation-delay:1.75s}.title span:nth-of-type(9){-webkit-animation-delay:2.2s;animation-delay:2.2s}.title span:nth-of-type(10){-webkit-animation-delay:2.7s;animation-delay:2.7s}.star{color:gold;position:fixed;top:7vh}",""])},475:function(n,e,t){"use strict";var o=t(344);t.n(o).a},476:function(n,e,t){(n.exports=t(39)(!1)).push([n.i,".foot{width:100vw;height:15vh;background:#000;text-align:center;padding-top:3vh;bottom:0}",""])},477:function(n,e,t){"use strict";var o={data:function(){return{}}},r=(t(473),t(21)),component=Object(r.a)(o,(function(){var n=this.$createElement;this._self._c;return this._m(0)}),[function(){var n=this,e=n.$createElement,t=n._self._c||e;return t("div",{staticClass:"black-head"},[t("h1",{staticClass:"title"},[t("span",[n._v("Z")]),n._v(" "),t("span",[n._v("O")]),n._v(" "),t("span",[n._v("D")]),n._v(" "),t("span",[n._v("I")]),n._v(" "),t("span",[n._v("A")]),n._v(" "),t("span",[n._v("C")]),n._v(" "),t("span",{staticStyle:{"margin-left":"var(--font-size)"}},[n._v("B")]),n._v(" "),t("span",[n._v("L")]),n._v(" "),t("span",[n._v("O")]),n._v(" "),t("span",[n._v("G")])]),n._v(" "),t("h4",{staticStyle:{"line-height":"1vh",color:"snow","text-align":"center","font-weight":"bold"}},[n._v("~ 技術的な防備録 ~")])])}],!1,null,null,null);e.a=component.exports},478:function(n,e,t){"use strict";var o=t(345),r=t.n(o),l={data:function(){return{now:r()().tz("Asia/Tokyo").format("Y")}}},c=(t(475),t(21)),component=Object(c.a)(l,(function(){var n=this.$createElement,e=this._self._c||n;return e("footer",{staticClass:"foot"},[e("font-awesome-icon",{staticClass:"icon",staticStyle:{color:"gold",margin:"0 1vw 0 1vw"},attrs:{onmouseover:"this.style.color='darkorange'",onmouseout:"this.style.color='gold'",onclick:"location.href='https://twitter.com/zodiac_G12'",icon:["fab","twitter-square"]}}),this._v(" "),e("font-awesome-icon",{staticClass:"icon",staticStyle:{color:"gold",margin:"0 1vw 0 1vw"},attrs:{onmouseover:"this.style.color='darkorange'",onmouseout:"this.style.color='gold'",onclick:"location.href='https://github.com/zodiac-G12'",icon:["fab","github-square"]}}),this._v(" "),e("font-awesome-icon",{staticClass:"icon",staticStyle:{color:"gold",margin:"0 1vw 0 1vw"},attrs:{onmouseover:"this.style.color='darkorange'",onmouseout:"this.style.color='gold'",onclick:"location.href='https://zodiac-G12.github.io/homepage'",icon:["fas","h-square"]}}),this._v(" "),e("p",{staticStyle:{color:"snow","font-weight":"bold"}},[this._v("© ZODIAC-G12 "+this._s(this.now))])],1)}),[],!1,null,null,null);e.a=component.exports},479:function(n,e,t){"use strict";t(73),t(102);var o={data:function(){return{pre:null,dir:null}},mounted:function(){this.pre=location.href.split("blog")[0]+"blog/",this.dir=location.href.replace(this.pre,"")+"の記事"}},r=t(21),component=Object(r.a)(o,(function(){var n=this.$createElement,e=this._self._c||n;return e("div",{staticStyle:{padding:"1vw 1vw 1vw 2vw",color:"black",background:"lavender","box-shadow":"5px 5px 0px 0px lightgray",margin:"0 5vw 0 5vw"}},[e("a",{staticStyle:{color:"black","font-weight":"bold"},attrs:{onmouseover:"this.style.color='red'",onmouseout:"this.style.color='black'",href:this.pre}},[e("font-awesome-icon",{staticClass:"small-icon",attrs:{icon:["fas","igloo"]}}),this._v(" BlogのHome\n    ")],1),this._v(" "),e("b",{staticStyle:{"margin-left":"1vw","margin-right":"1vw"}},[this._v(">")]),this._v(" "),e("b",[this._v(this._s(this.dir))])])}),[],!1,null,null,null);e.a=component.exports},481:function(n,e){n.exports=function(n){return n.webpackPolyfill||(n.deprecate=function(){},n.paths=[],n.children||(n.children=[]),Object.defineProperty(n,"loaded",{enumerable:!0,get:function(){return n.l}}),Object.defineProperty(n,"id",{enumerable:!0,get:function(){return n.i}}),n.webpackPolyfill=1),n}},482:function(n,e,t){var map={"./af":346,"./af.js":346,"./ar":347,"./ar-dz":348,"./ar-dz.js":348,"./ar-kw":349,"./ar-kw.js":349,"./ar-ly":350,"./ar-ly.js":350,"./ar-ma":351,"./ar-ma.js":351,"./ar-sa":352,"./ar-sa.js":352,"./ar-tn":353,"./ar-tn.js":353,"./ar.js":347,"./az":354,"./az.js":354,"./be":355,"./be.js":355,"./bg":356,"./bg.js":356,"./bm":357,"./bm.js":357,"./bn":358,"./bn.js":358,"./bo":359,"./bo.js":359,"./br":360,"./br.js":360,"./bs":361,"./bs.js":361,"./ca":362,"./ca.js":362,"./cs":363,"./cs.js":363,"./cv":364,"./cv.js":364,"./cy":365,"./cy.js":365,"./da":366,"./da.js":366,"./de":367,"./de-at":368,"./de-at.js":368,"./de-ch":369,"./de-ch.js":369,"./de.js":367,"./dv":370,"./dv.js":370,"./el":371,"./el.js":371,"./en-SG":372,"./en-SG.js":372,"./en-au":373,"./en-au.js":373,"./en-ca":374,"./en-ca.js":374,"./en-gb":375,"./en-gb.js":375,"./en-ie":376,"./en-ie.js":376,"./en-il":377,"./en-il.js":377,"./en-nz":378,"./en-nz.js":378,"./eo":379,"./eo.js":379,"./es":380,"./es-do":381,"./es-do.js":381,"./es-us":382,"./es-us.js":382,"./es.js":380,"./et":383,"./et.js":383,"./eu":384,"./eu.js":384,"./fa":385,"./fa.js":385,"./fi":386,"./fi.js":386,"./fo":387,"./fo.js":387,"./fr":388,"./fr-ca":389,"./fr-ca.js":389,"./fr-ch":390,"./fr-ch.js":390,"./fr.js":388,"./fy":391,"./fy.js":391,"./ga":392,"./ga.js":392,"./gd":393,"./gd.js":393,"./gl":394,"./gl.js":394,"./gom-latn":395,"./gom-latn.js":395,"./gu":396,"./gu.js":396,"./he":397,"./he.js":397,"./hi":398,"./hi.js":398,"./hr":399,"./hr.js":399,"./hu":400,"./hu.js":400,"./hy-am":401,"./hy-am.js":401,"./id":402,"./id.js":402,"./is":403,"./is.js":403,"./it":404,"./it-ch":405,"./it-ch.js":405,"./it.js":404,"./ja":406,"./ja.js":406,"./jv":407,"./jv.js":407,"./ka":408,"./ka.js":408,"./kk":409,"./kk.js":409,"./km":410,"./km.js":410,"./kn":411,"./kn.js":411,"./ko":412,"./ko.js":412,"./ku":413,"./ku.js":413,"./ky":414,"./ky.js":414,"./lb":415,"./lb.js":415,"./lo":416,"./lo.js":416,"./lt":417,"./lt.js":417,"./lv":418,"./lv.js":418,"./me":419,"./me.js":419,"./mi":420,"./mi.js":420,"./mk":421,"./mk.js":421,"./ml":422,"./ml.js":422,"./mn":423,"./mn.js":423,"./mr":424,"./mr.js":424,"./ms":425,"./ms-my":426,"./ms-my.js":426,"./ms.js":425,"./mt":427,"./mt.js":427,"./my":428,"./my.js":428,"./nb":429,"./nb.js":429,"./ne":430,"./ne.js":430,"./nl":431,"./nl-be":432,"./nl-be.js":432,"./nl.js":431,"./nn":433,"./nn.js":433,"./pa-in":434,"./pa-in.js":434,"./pl":435,"./pl.js":435,"./pt":436,"./pt-br":437,"./pt-br.js":437,"./pt.js":436,"./ro":438,"./ro.js":438,"./ru":439,"./ru.js":439,"./sd":440,"./sd.js":440,"./se":441,"./se.js":441,"./si":442,"./si.js":442,"./sk":443,"./sk.js":443,"./sl":444,"./sl.js":444,"./sq":445,"./sq.js":445,"./sr":446,"./sr-cyrl":447,"./sr-cyrl.js":447,"./sr.js":446,"./ss":448,"./ss.js":448,"./sv":449,"./sv.js":449,"./sw":450,"./sw.js":450,"./ta":451,"./ta.js":451,"./te":452,"./te.js":452,"./tet":453,"./tet.js":453,"./tg":454,"./tg.js":454,"./th":455,"./th.js":455,"./tl-ph":456,"./tl-ph.js":456,"./tlh":457,"./tlh.js":457,"./tr":458,"./tr.js":458,"./tzl":459,"./tzl.js":459,"./tzm":460,"./tzm-latn":461,"./tzm-latn.js":461,"./tzm.js":460,"./ug-cn":462,"./ug-cn.js":462,"./uk":463,"./uk.js":463,"./ur":464,"./ur.js":464,"./uz":465,"./uz-latn":466,"./uz-latn.js":466,"./uz.js":465,"./vi":467,"./vi.js":467,"./x-pseudo":468,"./x-pseudo.js":468,"./yo":469,"./yo.js":469,"./zh-cn":470,"./zh-cn.js":470,"./zh-hk":471,"./zh-hk.js":471,"./zh-tw":472,"./zh-tw.js":472};function o(n){var e=r(n);return t(e)}function r(n){if(!t.o(map,n)){var e=new Error("Cannot find module '"+n+"'");throw e.code="MODULE_NOT_FOUND",e}return map[n]}o.keys=function(){return Object.keys(map)},o.resolve=r,n.exports=o,o.id=482},524:function(n,e,t){"use strict";t.r(e);t(345);var o=t(477),r=t(478),l=t(479),c=t(74),j=t.n(c),d={data:function(){return{title:"AWS ALB のメンテナンス閉塞をShellスクリプト化した",url:"https:zodiac-G12.github.io/blog/2019-09-20",prekiji:'\n## 動機\n\n- 効率化\n\n## 初期設定\n\n- [AWS CLI](https://docs.aws.amazon.com/ja_jp/streams/latest/dev/kinesis-tutorial-cli-installation.html) および [jq](https://stedolan.github.io/jq/) がマシンにインストールされていることを確認。インストールされていなければインストール。\n\n```sh\n$ aws --version\naws-cli/1.16.215 Python/2.7.14 Linux/4.13.0-46-generic botocore/1.12.205\n```\n\n\n```sh\n$ jq --version\njq-1.5-1-a5b5cbe\n```\n\n- AWS CLI にアクセスキーを設定する\n> ⚠️ Default output format は **json** と絶対に全て小文字で入力すること。 Json や JSON では不可\n\n```sh\n$ aws configure\nAWS Access Key ID [None]: {accessKeyId}\nAWS Secret Access Key [None]: {secretAccessKey}\nDefault region name [None]: ap-northeast-1\nDefault output format [None]: json\n```\n\n- IAMユーザーが"maintenance"であること確認する\n\n```sh\n$ aws iam list-users\n{\n    "Users": [\n        {\n             ⋮\n        },\n        {\n             "UserName": "maintenance",\n             ⋮\n        },\n             ⋮\n        }\n    ]\n}\n```\n\n## 実践\n\n### ALBの閉塞(メンテナンス画面にする)\n\n- aws_alb_listener_dev_arn.json にAWS ALBのリスナーのARNを載っけときます。\n\n今回はALBが2つあって、それぞれに閉塞設定するというもので、api/v*直下アクセスのときはjson。\n其れ以外のときはHTMLを返すというものです。\n\n```sh\n####################################################################\n#\n#    メンテナンス開始のshellスクリプト(4つルールができる)\n#\n####################################################################\n\n\n# AWS ALBのリスナーのARNのjsonファイル名\njson="aws_alb_listener_dev_arn.json"\nmaintenance_statusCode=503\n\n# リスナーのARN\nlistener_one=$( cat $json | jq \'.[]\' | jq \'.[0]\' | jq -r \'.[]\' )\nlistener_two=$( cat $json | jq \'.[]\' | jq \'.[1]\' | jq -r \'.[]\' )\n\n\n############################# API v* 直下にアクセスされたときのJSON レスポンス(×2) #############################\n\n# 出力されたjsonをtmp.jsonとして一時保存\naws elbv2 create-rule \\\n    --listener-arn $listener_one \\\n    --conditions Field=path-pattern,Values="/api/v*" \\\n    --priority 1 \\\n    --actions Type=fixed-response,FixedResponseConfig={"MessageBody=\'{\\"id\\":-5000, \\"description\\":\\"ただいまメンテナンス中です。しばらくお待ちください\\"}\',StatusCode=$maintenance_statusCode,ContentType=application/json"} | tee tmp.json\n\n# ルールのARNを抽出(1個目)\nrule_three=$( cat tmp.json | jq \'.Rules[0].RuleArn\' )\n\naws elbv2 create-rule \\\n    --listener-arn $listener_two \\\n    --conditions Field=path-pattern,Values="api/v*" \\\n    --priority 1 \\\n    --actions Type=fixed-response,FixedResponseConfig={"MessageBody=\'{\\"id\\":-5000, \\"description\\":\\"ただいまメンテナンス中です。しばらくお待ちください\\"}\',StatusCode=$maintenance_statusCode,ContentType=application/json"} | tee tmp.json\n\n# ルールのARNを抽出(2個目)\nrule_four=$( cat tmp.json | jq \'.Rules[0].RuleArn\' )\n\n\n############################# API v* 直下以外の任意のパスにアクセスされたときのHTML レスポンス(×2) #############################\n\naws elbv2 create-rule \\\n    --listener-arn $listener_one \\\n    --conditions Field=path-pattern,Values="*" \\\n    --priority 2 \\\n    --actions Type=fixed-response,FixedResponseConfig={"MessageBody=<body><p>ただいまメンテナンス中です。しばらくお待ちください</p></body>,StatusCode=$maintenance_statusCode,ContentType=text/html"} | tee tmp.json\n\n# ルールのARNを抽出(3個目)\nrule_one=$( cat tmp.json | jq \'.Rules[0].RuleArn\' )\n\naws elbv2 create-rule \\\n    --listener-arn $listener_two \\\n    --conditions Field=path-pattern,Values="*" \\\n    --priority 2 \\\n    --actions Type=fixed-response,FixedResponseConfig={"MessageBody=<body><p>ただいまメンテナンス中です。しばらくお待ちください</p></body>,StatusCode=$maintenance_statusCode,ContentType=text/html"} | tee tmp.json\n\n# ルールのARNを抽出(4個目)\nrule_two=$( cat tmp.json | jq \'.Rules[0].RuleArn\' )\n\n\n# ルールのARNを変数に代入したらいらないので消す\nrm tmp.json\n\n# ルールのARNの保存形式\nrule_arn_json="{\n    \\"development_alb_rule_arns\\": [\n        {\\"rule_one\\": $rule_one},\n        {\\"rule_two\\": $rule_two},\n        {\\"rule_three\\": $rule_three},\n        {\\"rule_four\\": $rule_four}\n    ]\n}"\n\n# ルールのARNのjsonを新規作成する\necho $rule_arn_json | tee aws_alb_rule_dev_arn.json\n\necho maintenance start.\n```\n\n### ALBの閉塞解除(メンテナンス画面解除)\n\n```sh\n# AWS ALBのリスナーのルールのARNのjsonファイル名\njson="aws_alb_rule_dev_arn.json"\n\n# ルールのARN\nrule_one=$( cat $json | jq \'.[]\' | jq \'.[0]\' | jq -r \'.[]\')\nrule_two=$( cat $json | jq \'.[]\' | jq \'.[1]\' | jq -r \'.[]\')\nrule_three=$( cat $json | jq \'.[]\' | jq \'.[2]\' | jq -r \'.[]\')\nrule_four=$( cat $json | jq \'.[]\' | jq \'.[3]\' | jq -r \'.[]\')\n\n# ルールの削除によってメンテナンス表示の解除\naws elbv2 delete-rule --rule-arn $rule_one\naws elbv2 delete-rule --rule-arn $rule_two\naws elbv2 delete-rule --rule-arn $rule_three\naws elbv2 delete-rule --rule-arn $rule_four\n\n# ルールを削除したらファイルは不要なので削除する\nrm $json\n\necho maintenance stopped.\n```\n\n### 感想\n\n人間そんな簡単に死なない。\n\n'}},head:function(){return{title:this.title,meta:[{hid:"og:url",property:"og:url",content:this.url},{hid:"og:description",property:"og:description",content:"programming"},{hid:"og:title",property:"og:title",content:"ZODIAC BLOG - ".concat(this.title)}]}},computed:{kiji:function(){return j()(this.prekiji)}},components:{defaultFooter:r.a,defaultHeader:o.a,pankuz:l.a}},h=t(21),component=Object(h.a)(d,(function(){var n=this,e=n.$createElement,t=n._self._c||e;return t("div",[t("default-header"),n._v(" "),t("pankuz"),n._v(" "),t("main",{staticStyle:{padding:"5vw"}},[t("h3",{staticStyle:{"box-shadow":"5px 5px 0px 0px darkslategray",background:"linear-gradient(-45deg, darkslategray, black, darkslategray)",color:"white",padding:"2vw","text-align":"center"}},[t("b",{staticClass:"midashi",staticStyle:{"border-bottom":"dotted 3px crimson"}},[n._v("\n                "+n._s(n.title)+"\n                "),t("font-awesome-icon",{staticClass:"icon",staticStyle:{color:"darkorange"},attrs:{icon:["fab","aws"]}})],1)]),n._v(" "),t("div",{staticStyle:{"box-shadow":"5px 5px 0px 0px wheat",background:"white",padding:"5vw"},domProps:{innerHTML:n._s(n.kiji)}})]),n._v(" "),t("default-footer")],1)}),[],!1,null,null,null);e.default=component.exports}}]);