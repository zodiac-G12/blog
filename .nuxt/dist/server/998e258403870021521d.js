exports.ids=[1],exports.modules={32:function(n,e,t){var content=t(35);"string"==typeof content&&(content=[[n.i,content,""]]),content.locals&&(n.exports=content.locals);var o=t(5).default;n.exports.__inject__=function(n){o("31ebe3ef",content,!0,n)}},33:function(n,e,t){var content=t(37);"string"==typeof content&&(content=[[n.i,content,""]]),content.locals&&(n.exports=content.locals);var o=t(5).default;n.exports.__inject__=function(n){o("2932acaf",content,!0,n)}},34:function(n,e,t){"use strict";t.r(e);var o=t(32),r=t.n(o);for(var l in o)"default"!==l&&function(n){t.d(e,n,(function(){return o[n]}))}(l);e.default=r.a},35:function(n,e,t){(n.exports=t(4)(!1)).push([n.i,"@media screen and (orientation:portrait){.black-head{height:20vh}.title{line-height:12vh}}@media screen and (orientation:landscape){.black-head{height:30vh}.title{line-height:19vh}}.black-head{width:100vw;background:linear-gradient(90deg,#7e0f4b,#1a5865);margin:0;color:snow}.title{text-align:center;font-family:Bungee Inline;font-weight:400;margin-top:0;color:#fff}.title span{margin-right:-.5vw;-webkit-animation:bakemono 10s ease-in-out infinite;animation:bakemono 10s ease-in-out infinite}@-webkit-keyframes bakemono{0%{font-family:Bungee Inline}to{font-family:Bungee Shade}}@keyframes bakemono{0%{font-family:Bungee Inline}to{font-family:Bungee Shade}}.title span:first-of-type{-webkit-animation-delay:0s;animation-delay:0s}.title span:nth-of-type(2){-webkit-animation-delay:.1s;animation-delay:.1s}.title span:nth-of-type(3){-webkit-animation-delay:.25s;animation-delay:.25s}.title span:nth-of-type(4){-webkit-animation-delay:.45s;animation-delay:.45s}.title span:nth-of-type(5){-webkit-animation-delay:.7s;animation-delay:.7s}.title span:nth-of-type(6){-webkit-animation-delay:1s;animation-delay:1s}.title span:nth-of-type(7){-webkit-animation-delay:1.35s;animation-delay:1.35s}.title span:nth-of-type(8){-webkit-animation-delay:1.75s;animation-delay:1.75s}.title span:nth-of-type(9){-webkit-animation-delay:2.2s;animation-delay:2.2s}.title span:nth-of-type(10){-webkit-animation-delay:2.7s;animation-delay:2.7s}.star{color:gold;position:fixed;top:7vh}",""])},36:function(n,e,t){"use strict";t.r(e);var o=t(33),r=t.n(o);for(var l in o)"default"!==l&&function(n){t.d(e,n,(function(){return o[n]}))}(l);e.default=r.a},37:function(n,e,t){(n.exports=t(4)(!1)).push([n.i,".foot{width:100vw;height:15vh;background:#000;text-align:center;padding-top:3vh;bottom:0}",""])},38:function(n,e,t){"use strict";var o={data:function(){return{}}},r=t(3);var component=Object(r.a)(o,(function(){var n=this.$createElement;return(this._self._c||n)("div",{staticClass:"black-head"},[this._ssrNode('<h1 class="title"><span>Z</span> <span>O</span> <span>D</span> <span>I</span> <span>A</span> <span>C</span> <span style="margin-left:var(--font-size);">B</span> <span>L</span> <span>O</span> <span>G</span></h1> <h4 style="line-height:1vh;color:snow;text-align:center;font-weight:bold;">~ 技術的な防備録 ~</h4>')])}),[],!1,(function(n){var e=t(34);e.__inject__&&e.__inject__(n)}),null,"7dd5fa2e");e.a=component.exports},39:function(n,e,t){"use strict";var o=t(30),r=t.n(o),l={data:function(){return{now:r()().tz("Asia/Tokyo").format("Y")}}},c=t(3);var component=Object(c.a)(l,(function(){var n=this.$createElement,e=this._self._c||n;return e("footer",{staticClass:"foot"},[e("font-awesome-icon",{staticClass:"icon",staticStyle:{color:"gold",margin:"0 1vw 0 1vw"},attrs:{onmouseover:"this.style.color='darkorange'",onmouseout:"this.style.color='gold'",onclick:"location.href='https://twitter.com/zodiac_G12'",icon:["fab","twitter-square"]}}),this._ssrNode(" "),e("font-awesome-icon",{staticClass:"icon",staticStyle:{color:"gold",margin:"0 1vw 0 1vw"},attrs:{onmouseover:"this.style.color='darkorange'",onmouseout:"this.style.color='gold'",onclick:"location.href='https://github.com/zodiac-G12'",icon:["fab","github-square"]}}),this._ssrNode(" "),e("font-awesome-icon",{staticClass:"icon",staticStyle:{color:"gold",margin:"0 1vw 0 1vw"},attrs:{onmouseover:"this.style.color='darkorange'",onmouseout:"this.style.color='gold'",onclick:"location.href='https://zodiac-G12.github.io/homepage'",icon:["fas","h-square"]}}),this._ssrNode(' <p style="color:snow;font-weight:bold;">'+this._ssrEscape("© ZODIAC-G12 "+this._s(this.now))+"</p>")],2)}),[],!1,(function(n){var e=t(36);e.__inject__&&e.__inject__(n)}),null,"c03ac212");e.a=component.exports},40:function(n,e,t){"use strict";var o={data:function(){return{pre:null,dir:null}},mounted(){this.pre=location.href.split("blog")[0]+"blog/",this.dir=location.href.replace(this.pre,"")+"の記事"}},r=t(3),component=Object(r.a)(o,(function(){var n=this.$createElement,e=this._self._c||n;return e("div",{staticStyle:{padding:"1vw 1vw 1vw 2vw",color:"black",background:"lavender","box-shadow":"5px 5px 0px 0px lightgray",margin:"0 5vw 0 5vw"}},[this._ssrNode("<a onmouseover=\"this.style.color='red'\" onmouseout=\"this.style.color='black'\""+this._ssrAttr("href",this.pre)+' style="color:black;font-weight:bold;">',"</a>",[e("font-awesome-icon",{staticClass:"small-icon",attrs:{icon:["fas","igloo"]}}),this._ssrNode(" BlogのHome\n    ")],2),this._ssrNode(' <b style="margin-left:1vw;margin-right:1vw;">&gt;</b> <b>'+this._ssrEscape(this._s(this.dir))+"</b>")],2)}),[],!1,null,null,"1627e0e3");e.a=component.exports},49:function(n,e,t){"use strict";t.r(e);t(30);var o=t(38),r=t(39),l=t(40),c=t(13),d=t.n(c),h={data:function(){return{title:"AWS ALB のメンテナンス閉塞をShellスクリプト化した",url:"https:zodiac-G12.github.io/blog/2019-09-20",prekiji:'\n## 動機\n\n- 効率化\n\n## 初期設定\n\n- [AWS CLI](https://docs.aws.amazon.com/ja_jp/streams/latest/dev/kinesis-tutorial-cli-installation.html) および [jq](https://stedolan.github.io/jq/) がマシンにインストールされていることを確認。インストールされていなければインストール。\n\n```sh\n$ aws --version\naws-cli/1.16.215 Python/2.7.14 Linux/4.13.0-46-generic botocore/1.12.205\n```\n\n\n```sh\n$ jq --version\njq-1.5-1-a5b5cbe\n```\n\n- AWS CLI にアクセスキーを設定する\n> ⚠️ Default output format は **json** と絶対に全て小文字で入力すること。 Json や JSON では不可\n\n```sh\n$ aws configure\nAWS Access Key ID [None]: {accessKeyId}\nAWS Secret Access Key [None]: {secretAccessKey}\nDefault region name [None]: ap-northeast-1\nDefault output format [None]: json\n```\n\n- IAMユーザーが"maintenance"であること確認する\n\n```sh\n$ aws iam list-users\n{\n    "Users": [\n        {\n             ⋮\n        },\n        {\n             "UserName": "maintenance",\n             ⋮\n        },\n             ⋮\n        }\n    ]\n}\n```\n\n## 実践\n\n### ALBの閉塞(メンテナンス画面にする)\n\n- aws_alb_listener_dev_arn.json にAWS ALBのリスナーのARNを載っけときます。\n\n今回はALBが2つあって、それぞれに閉塞設定するというもので、api/v*直下アクセスのときはjson。\n其れ以外のときはHTMLを返すというものです。\n\n```sh\n####################################################################\n#\n#    メンテナンス開始のshellスクリプト(4つルールができる)\n#\n####################################################################\n\n\n# AWS ALBのリスナーのARNのjsonファイル名\njson="aws_alb_listener_dev_arn.json"\nmaintenance_statusCode=503\n\n# リスナーのARN\nlistener_one=$( cat $json | jq \'.[]\' | jq \'.[0]\' | jq -r \'.[]\' )\nlistener_two=$( cat $json | jq \'.[]\' | jq \'.[1]\' | jq -r \'.[]\' )\n\n\n############################# API v* 直下にアクセスされたときのJSON レスポンス(×2) #############################\n\n# 出力されたjsonをtmp.jsonとして一時保存\naws elbv2 create-rule \\\n    --listener-arn $listener_one \\\n    --conditions Field=path-pattern,Values="/api/v*" \\\n    --priority 1 \\\n    --actions Type=fixed-response,FixedResponseConfig={"MessageBody=\'{\\"id\\":-5000, \\"description\\":\\"ただいまメンテナンス中です。しばらくお待ちください\\"}\',StatusCode=$maintenance_statusCode,ContentType=application/json"} | tee tmp.json\n\n# ルールのARNを抽出(1個目)\nrule_three=$( cat tmp.json | jq \'.Rules[0].RuleArn\' )\n\naws elbv2 create-rule \\\n    --listener-arn $listener_two \\\n    --conditions Field=path-pattern,Values="api/v*" \\\n    --priority 1 \\\n    --actions Type=fixed-response,FixedResponseConfig={"MessageBody=\'{\\"id\\":-5000, \\"description\\":\\"ただいまメンテナンス中です。しばらくお待ちください\\"}\',StatusCode=$maintenance_statusCode,ContentType=application/json"} | tee tmp.json\n\n# ルールのARNを抽出(2個目)\nrule_four=$( cat tmp.json | jq \'.Rules[0].RuleArn\' )\n\n\n############################# API v* 直下以外の任意のパスにアクセスされたときのHTML レスポンス(×2) #############################\n\naws elbv2 create-rule \\\n    --listener-arn $listener_one \\\n    --conditions Field=path-pattern,Values="*" \\\n    --priority 2 \\\n    --actions Type=fixed-response,FixedResponseConfig={"MessageBody=<body><p>ただいまメンテナンス中です。しばらくお待ちください</p></body>,StatusCode=$maintenance_statusCode,ContentType=text/html"} | tee tmp.json\n\n# ルールのARNを抽出(3個目)\nrule_one=$( cat tmp.json | jq \'.Rules[0].RuleArn\' )\n\naws elbv2 create-rule \\\n    --listener-arn $listener_two \\\n    --conditions Field=path-pattern,Values="*" \\\n    --priority 2 \\\n    --actions Type=fixed-response,FixedResponseConfig={"MessageBody=<body><p>ただいまメンテナンス中です。しばらくお待ちください</p></body>,StatusCode=$maintenance_statusCode,ContentType=text/html"} | tee tmp.json\n\n# ルールのARNを抽出(4個目)\nrule_two=$( cat tmp.json | jq \'.Rules[0].RuleArn\' )\n\n\n# ルールのARNを変数に代入したらいらないので消す\nrm tmp.json\n\n# ルールのARNの保存形式\nrule_arn_json="{\n    \\"development_alb_rule_arns\\": [\n        {\\"rule_one\\": $rule_one},\n        {\\"rule_two\\": $rule_two},\n        {\\"rule_three\\": $rule_three},\n        {\\"rule_four\\": $rule_four}\n    ]\n}"\n\n# ルールのARNのjsonを新規作成する\necho $rule_arn_json | tee aws_alb_rule_dev_arn.json\n\necho maintenance start.\n```\n\n### ALBの閉塞解除(メンテナンス画面解除)\n\n```sh\n# AWS ALBのリスナーのルールのARNのjsonファイル名\njson="aws_alb_rule_dev_arn.json"\n\n# ルールのARN\nrule_one=$( cat $json | jq \'.[]\' | jq \'.[0]\' | jq -r \'.[]\')\nrule_two=$( cat $json | jq \'.[]\' | jq \'.[1]\' | jq -r \'.[]\')\nrule_three=$( cat $json | jq \'.[]\' | jq \'.[2]\' | jq -r \'.[]\')\nrule_four=$( cat $json | jq \'.[]\' | jq \'.[3]\' | jq -r \'.[]\')\n\n# ルールの削除によってメンテナンス表示の解除\naws elbv2 delete-rule --rule-arn $rule_one\naws elbv2 delete-rule --rule-arn $rule_two\naws elbv2 delete-rule --rule-arn $rule_three\naws elbv2 delete-rule --rule-arn $rule_four\n\n# ルールを削除したらファイルは不要なので削除する\nrm $json\n\necho maintenance stopped.\n```\n\n### 感想\n\n人間そんな簡単に死なない。\n\n'}},head(){return{title:this.title,meta:[{hid:"og:url",property:"og:url",content:this.url},{hid:"og:description",property:"og:description",content:"programming"},{hid:"og:title",property:"og:title",content:`ZODIAC BLOG - ${this.title}`}]}},computed:{kiji(){return d()(this.prekiji)}},components:{defaultFooter:r.a,defaultHeader:o.a,pankuz:l.a}},f=t(3),component=Object(f.a)(h,(function(){var n=this,e=n.$createElement,t=n._self._c||e;return t("div",[t("default-header"),n._ssrNode(" "),t("pankuz"),n._ssrNode(" "),n._ssrNode('<main style="padding:5vw;">',"</main>",[n._ssrNode('<h3 style="box-shadow:5px 5px 0px 0px darkslategray;background:linear-gradient(-45deg, darkslategray, black, darkslategray);color:white;padding:2vw;text-align:center;">',"</h3>",[n._ssrNode('<b class="midashi" style="border-bottom: dotted 3px crimson;">',"</b>",[n._ssrNode(n._ssrEscape("\n                "+n._s(n.title)+"\n                ")),t("font-awesome-icon",{staticClass:"icon",staticStyle:{color:"darkorange"},attrs:{icon:["fab","aws"]}})],2)]),n._ssrNode(' <div style="box-shadow:5px 5px 0px 0px wheat;background:white;padding:5vw;">'+n._s(n.kiji)+"</div>")],2),n._ssrNode(" "),t("default-footer")],2)}),[],!1,null,null,"60f3d71f");e.default=component.exports}};
//# sourceMappingURL=998e258403870021521d.js.map