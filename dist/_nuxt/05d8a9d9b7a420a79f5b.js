(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{367:function(n,e,t){"use strict";var o={data:function(){return{}}},r=t(26),component=Object(r.a)(o,(function(){var n=this.$createElement;this._self._c;return this._m(0)}),[function(){var n=this,e=n.$createElement,t=n._self._c||e;return t("div",{staticClass:"black-head"},[t("h1",{staticClass:"title"},[t("span",[n._v("Z")]),n._v(" "),t("span",[n._v("O")]),n._v(" "),t("span",[n._v("D")]),n._v(" "),t("span",[n._v("I")]),n._v(" "),t("span",[n._v("A")]),n._v(" "),t("span",[n._v("C")]),n._v(" "),t("span",{staticStyle:{"margin-left":"var(--font-size)"}},[n._v("B")]),n._v(" "),t("span",[n._v("L")]),n._v(" "),t("span",[n._v("O")]),n._v(" "),t("span",[n._v("G")])]),n._v(" "),t("h4",{staticStyle:{"line-height":"1vh",color:"snow","text-align":"center","font-weight":"bold"}},[n._v("~ 技術的な防備録 ~")])])}],!1,null,null,null);e.a=component.exports},368:function(n,e,t){"use strict";var o=t(239),r=t.n(o),l={data:function(){return{now:r()().tz("Asia/Tokyo").format("Y")}}},c=t(26),component=Object(c.a)(l,(function(){var n=this.$createElement,e=this._self._c||n;return e("footer",{staticClass:"foot"},[e("font-awesome-icon",{staticClass:"icon",staticStyle:{color:"gold",margin:"0 0.1vw 0 0.1vw"},attrs:{onmouseover:"this.style.color='darkorange'",onmouseout:"this.style.color='gold'",onclick:"location.href='https://twitter.com/zodiac_G12'",icon:["fab","twitter-square"]}}),this._v(" "),e("font-awesome-icon",{staticClass:"icon",staticStyle:{color:"gold",margin:"0 0.1vw 0 0.1vw"},attrs:{onmouseover:"this.style.color='darkorange'",onmouseout:"this.style.color='gold'",onclick:"location.href='https://github.com/zodiac-G12'",icon:["fab","github-square"]}}),this._v(" "),e("font-awesome-icon",{staticClass:"icon",staticStyle:{color:"gold",margin:"0 0.1vw 0 0.1vw"},attrs:{onmouseover:"this.style.color='darkorange'",onmouseout:"this.style.color='gold'",onclick:"location.href='https://zodiac-G12.github.io/homepage'",icon:["fas","h-square"]}}),this._v(" "),e("p",{staticStyle:{color:"snow","font-weight":"bold"}},[this._v("© ZODIAC-G12 "+this._s(this.now))])],1)}),[],!1,null,null,null);e.a=component.exports},369:function(n,e,t){"use strict";t(101),t(142);var o={data:function(){return{pre:null,dir:null}},mounted:function(){this.pre=location.href.split("blog")[0]+"blog/",this.dir=location.href.replace(this.pre,"")}},r=t(26),component=Object(r.a)(o,(function(){var n=this.$createElement,e=this._self._c||n;return e("div",{staticStyle:{padding:"1vw",width:"100vw",color:"white",background:"darkslategray","padding-left":"5vw"}},[e("a",{staticStyle:{color:"white","font-weight":"bold"},attrs:{onmouseover:"this.style.color='maroon'",onmouseout:"this.style.color='white'",href:this.pre}},[e("font-awesome-icon",{staticClass:"small-icon",attrs:{icon:["fas","igloo"]}}),this._v(" Home\n    ")],1),this._v(" "),e("b",{staticStyle:{"margin-left":"1vw","margin-right":"1vw"}},[this._v(">")]),this._v(" "),e("b",[this._v(this._s(this.dir))])])}),[],!1,null,null,null);e.a=component.exports},370:function(n,e,t){var map={"./af":240,"./af.js":240,"./ar":241,"./ar-dz":242,"./ar-dz.js":242,"./ar-kw":243,"./ar-kw.js":243,"./ar-ly":244,"./ar-ly.js":244,"./ar-ma":245,"./ar-ma.js":245,"./ar-sa":246,"./ar-sa.js":246,"./ar-tn":247,"./ar-tn.js":247,"./ar.js":241,"./az":248,"./az.js":248,"./be":249,"./be.js":249,"./bg":250,"./bg.js":250,"./bm":251,"./bm.js":251,"./bn":252,"./bn.js":252,"./bo":253,"./bo.js":253,"./br":254,"./br.js":254,"./bs":255,"./bs.js":255,"./ca":256,"./ca.js":256,"./cs":257,"./cs.js":257,"./cv":258,"./cv.js":258,"./cy":259,"./cy.js":259,"./da":260,"./da.js":260,"./de":261,"./de-at":262,"./de-at.js":262,"./de-ch":263,"./de-ch.js":263,"./de.js":261,"./dv":264,"./dv.js":264,"./el":265,"./el.js":265,"./en-SG":266,"./en-SG.js":266,"./en-au":267,"./en-au.js":267,"./en-ca":268,"./en-ca.js":268,"./en-gb":269,"./en-gb.js":269,"./en-ie":270,"./en-ie.js":270,"./en-il":271,"./en-il.js":271,"./en-nz":272,"./en-nz.js":272,"./eo":273,"./eo.js":273,"./es":274,"./es-do":275,"./es-do.js":275,"./es-us":276,"./es-us.js":276,"./es.js":274,"./et":277,"./et.js":277,"./eu":278,"./eu.js":278,"./fa":279,"./fa.js":279,"./fi":280,"./fi.js":280,"./fo":281,"./fo.js":281,"./fr":282,"./fr-ca":283,"./fr-ca.js":283,"./fr-ch":284,"./fr-ch.js":284,"./fr.js":282,"./fy":285,"./fy.js":285,"./ga":286,"./ga.js":286,"./gd":287,"./gd.js":287,"./gl":288,"./gl.js":288,"./gom-latn":289,"./gom-latn.js":289,"./gu":290,"./gu.js":290,"./he":291,"./he.js":291,"./hi":292,"./hi.js":292,"./hr":293,"./hr.js":293,"./hu":294,"./hu.js":294,"./hy-am":295,"./hy-am.js":295,"./id":296,"./id.js":296,"./is":297,"./is.js":297,"./it":298,"./it-ch":299,"./it-ch.js":299,"./it.js":298,"./ja":300,"./ja.js":300,"./jv":301,"./jv.js":301,"./ka":302,"./ka.js":302,"./kk":303,"./kk.js":303,"./km":304,"./km.js":304,"./kn":305,"./kn.js":305,"./ko":306,"./ko.js":306,"./ku":307,"./ku.js":307,"./ky":308,"./ky.js":308,"./lb":309,"./lb.js":309,"./lo":310,"./lo.js":310,"./lt":311,"./lt.js":311,"./lv":312,"./lv.js":312,"./me":313,"./me.js":313,"./mi":314,"./mi.js":314,"./mk":315,"./mk.js":315,"./ml":316,"./ml.js":316,"./mn":317,"./mn.js":317,"./mr":318,"./mr.js":318,"./ms":319,"./ms-my":320,"./ms-my.js":320,"./ms.js":319,"./mt":321,"./mt.js":321,"./my":322,"./my.js":322,"./nb":323,"./nb.js":323,"./ne":324,"./ne.js":324,"./nl":325,"./nl-be":326,"./nl-be.js":326,"./nl.js":325,"./nn":327,"./nn.js":327,"./pa-in":328,"./pa-in.js":328,"./pl":329,"./pl.js":329,"./pt":330,"./pt-br":331,"./pt-br.js":331,"./pt.js":330,"./ro":332,"./ro.js":332,"./ru":333,"./ru.js":333,"./sd":334,"./sd.js":334,"./se":335,"./se.js":335,"./si":336,"./si.js":336,"./sk":337,"./sk.js":337,"./sl":338,"./sl.js":338,"./sq":339,"./sq.js":339,"./sr":340,"./sr-cyrl":341,"./sr-cyrl.js":341,"./sr.js":340,"./ss":342,"./ss.js":342,"./sv":343,"./sv.js":343,"./sw":344,"./sw.js":344,"./ta":345,"./ta.js":345,"./te":346,"./te.js":346,"./tet":347,"./tet.js":347,"./tg":348,"./tg.js":348,"./th":349,"./th.js":349,"./tl-ph":350,"./tl-ph.js":350,"./tlh":351,"./tlh.js":351,"./tr":352,"./tr.js":352,"./tzl":353,"./tzl.js":353,"./tzm":354,"./tzm-latn":355,"./tzm-latn.js":355,"./tzm.js":354,"./ug-cn":356,"./ug-cn.js":356,"./uk":357,"./uk.js":357,"./ur":358,"./ur.js":358,"./uz":359,"./uz-latn":360,"./uz-latn.js":360,"./uz.js":359,"./vi":361,"./vi.js":361,"./x-pseudo":362,"./x-pseudo.js":362,"./yo":363,"./yo.js":363,"./zh-cn":364,"./zh-cn.js":364,"./zh-hk":365,"./zh-hk.js":365,"./zh-tw":366,"./zh-tw.js":366};function o(n){var e=r(n);return t(e)}function r(n){if(!t.o(map,n)){var e=new Error("Cannot find module '"+n+"'");throw e.code="MODULE_NOT_FOUND",e}return map[n]}o.keys=function(){return Object.keys(map)},o.resolve=r,n.exports=o,o.id=370},569:function(n,e,t){"use strict";t.r(e);t(239);var o=t(367),r=t(368),l=t(369),c=t(371),j=t.n(c),h=t(372),d=t.n(h),m={data:function(){return{title:"AWS ALB のメンテナンス閉塞をShellスクリプト化した",url:"https:zodiac-G12.github.io/blog/2019-09-20",kiji:null,prekiji:'\n## 動機\n\n- 効率化\n\n---\n\n## 初期設定\n\n- [AWS CLI](https://docs.aws.amazon.com/ja_jp/streams/latest/dev/kinesis-tutorial-cli-installation.html) および [jq](https://stedolan.github.io/jq/) がマシンにインストールされていることを確認。インストールされていなければインストール。\n\n```sh\n$ aws --version\naws-cli/1.16.215 Python/2.7.14 Linux/4.13.0-46-generic botocore/1.12.205\n```\n\n\n```sh\n$ jq --version\njq-1.5-1-a5b5cbe\n```\n\n- AWS CLI にアクセスキーを設定する\n> ⚠️ Default output format は **json** と絶対に全て小文字で入力すること。 Json や JSON では不可\n\n```sh\n$ aws configure\nAWS Access Key ID [None]: {accessKeyId}\nAWS Secret Access Key [None]: {secretAccessKey}\nDefault region name [None]: ap-northeast-1\nDefault output format [None]: json\n```\n\n- IAMユーザーが"maintenance"であること確認する\n\n```sh\n$ aws iam list-users\n{\n    "Users": [\n        {\n             ⋮\n        },\n        {\n             "UserName": "maintenance",\n             ⋮\n        },\n             ⋮\n        }\n    ]\n}\n```\n\n## 実践\n\n### ALBの閉塞(メンテナンス画面にする)\n\n- aws_alb_listener_dev_arn.json にAWS ALBのリスナーのARNを載っけときます。\n\n今回はALBが2つあって、それぞれに閉塞設定するというもので、api/v*直下アクセスのときはjson。\n其れ以外のときはHTMLを返すというものです。\n\n```sh\n####################################################################\n#\n#    メンテナンス開始のshellスクリプト(4つルールができる)\n#\n####################################################################\n\n\n# AWS ALBのリスナーのARNのjsonファイル名\njson="aws_alb_listener_dev_arn.json"\nmaintenance_statusCode=503\n\n# リスナーのARN\nlistener_one=$( cat $json | jq \'.[]\' | jq \'.[0]\' | jq -r \'.[]\' )\nlistener_two=$( cat $json | jq \'.[]\' | jq \'.[1]\' | jq -r \'.[]\' )\n\n\n############################# API v* 直下にアクセスされたときのJSON レスポンス(×2) #############################\n\n# 出力されたjsonをtmp.jsonとして一時保存\naws elbv2 create-rule \\\n    --listener-arn $listener_one \\\n    --conditions Field=path-pattern,Values="/api/v*" \\\n    --priority 1 \\\n    --actions Type=fixed-response,FixedResponseConfig={"MessageBody=\'{\\"id\\":-5000, \\"description\\":\\"ただいまメンテナンス中です。しばらくお待ちください\\"}\',StatusCode=$maintenance_statusCode,ContentType=application/json"} | tee tmp.json\n\n# ルールのARNを抽出(1個目)\nrule_three=$( cat tmp.json | jq \'.Rules[0].RuleArn\' )\n\naws elbv2 create-rule \\\n    --listener-arn $listener_two \\\n    --conditions Field=path-pattern,Values="api/v*" \\\n    --priority 1 \\\n    --actions Type=fixed-response,FixedResponseConfig={"MessageBody=\'{\\"id\\":-5000, \\"description\\":\\"ただいまメンテナンス中です。しばらくお待ちください\\"}\',StatusCode=$maintenance_statusCode,ContentType=application/json"} | tee tmp.json\n\n# ルールのARNを抽出(2個目)\nrule_four=$( cat tmp.json | jq \'.Rules[0].RuleArn\' )\n\n\n############################# API v* 直下以外の任意のパスにアクセスされたときのHTML レスポンス(×2) #############################\n\naws elbv2 create-rule \\\n    --listener-arn $listener_one \\\n    --conditions Field=path-pattern,Values="*" \\\n    --priority 2 \\\n    --actions Type=fixed-response,FixedResponseConfig={"MessageBody=<body><p>ただいまメンテナンス中です。しばらくお待ちください</p></body>,StatusCode=$maintenance_statusCode,ContentType=text/html"} | tee tmp.json\n\n# ルールのARNを抽出(3個目)\nrule_one=$( cat tmp.json | jq \'.Rules[0].RuleArn\' )\n\naws elbv2 create-rule \\\n    --listener-arn $listener_two \\\n    --conditions Field=path-pattern,Values="*" \\\n    --priority 2 \\\n    --actions Type=fixed-response,FixedResponseConfig={"MessageBody=<body><p>ただいまメンテナンス中です。しばらくお待ちください</p></body>,StatusCode=$maintenance_statusCode,ContentType=text/html"} | tee tmp.json\n\n# ルールのARNを抽出(4個目)\nrule_two=$( cat tmp.json | jq \'.Rules[0].RuleArn\' )\n\n\n# ルールのARNを変数に代入したらいらないので消す\nrm tmp.json\n\n# ルールのARNの保存形式\nrule_arn_json="{\n    \\"development_alb_rule_arns\\": [\n        {\\"rule_one\\": $rule_one},\n        {\\"rule_two\\": $rule_two},\n        {\\"rule_three\\": $rule_three},\n        {\\"rule_four\\": $rule_four}\n    ]\n}"\n\n# ルールのARNのjsonを新規作成する\necho $rule_arn_json | tee aws_alb_rule_dev_arn.json\n\necho maintenance start.\n```\n\n### ALBの閉塞解除(メンテナンス画面解除)\n\n```sh\n# AWS ALBのリスナーのルールのARNのjsonファイル名\njson="aws_alb_rule_dev_arn.json"\n\n# ルールのARN\nrule_one=$( cat $json | jq \'.[]\' | jq \'.[0]\' | jq -r \'.[]\')\nrule_two=$( cat $json | jq \'.[]\' | jq \'.[1]\' | jq -r \'.[]\')\nrule_three=$( cat $json | jq \'.[]\' | jq \'.[2]\' | jq -r \'.[]\')\nrule_four=$( cat $json | jq \'.[]\' | jq \'.[3]\' | jq -r \'.[]\')\n\n# ルールの削除によってメンテナンス表示の解除\naws elbv2 delete-rule --rule-arn $rule_one\naws elbv2 delete-rule --rule-arn $rule_two\naws elbv2 delete-rule --rule-arn $rule_three\naws elbv2 delete-rule --rule-arn $rule_four\n\n# ルールを削除したらファイルは不要なので削除する\nrm $json\n\necho maintenance stopped.\n```\n\n### 感想\n\n人間そんな簡単に死なない。\n\n'}},head:function(){return{title:this.title,meta:[{hid:"og:url",property:"og:url",content:this.url}]}},created:function(){d.a.setOptions({langPrefix:"",highlight:function(code,n){return j.a.highlightAuto(code,[n]).value}})},mounted:function(){j.a.initHighlightingOnLoad(),this.kiji=d()(this.escape(this.prekiji))},methods:{escape:function(n){return n}},components:{defaultFooter:r.a,defaultHeader:o.a,pankuz:l.a}},_=(t(373),t(26)),component=Object(_.a)(m,(function(){var n=this,e=n.$createElement,t=n._self._c||e;return t("div",[t("default-header"),n._v(" "),t("pankuz"),n._v(" "),t("main",{staticStyle:{padding:"5vw"}},[t("h3",{staticStyle:{"box-shadow":"5px 5px 0px 0px darkslategray",background:"darkgreen",color:"white",padding:"2vw","text-align":"center"}},[t("b",{staticClass:"midashi",staticStyle:{"border-bottom":"dotted 3px crimson"}},[n._v("\n                "+n._s(n.title)+"\n                "),t("font-awesome-icon",{staticClass:"icon",staticStyle:{color:"darkorange"},attrs:{icon:["fab","aws"]}})],1)]),n._v(" "),t("div",{staticStyle:{"box-shadow":"5px 5px 0px 0px wheat",background:"white",padding:"5vw"},domProps:{innerHTML:n._s(n.kiji)}})]),n._v(" "),t("default-footer")],1)}),[],!1,null,null,null);e.default=component.exports}}]);